<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>法務省登記所備付地図データ 公共座標の筆かつ所属する市区町村外の座標を可視化</title>
  <link rel="stylesheet" href="./style.css">
</head>

<body>
  <div id="map" class="left" data-zoom="5" data-lat="37.01" data-lng="138.09" data-hash="on" data-marker="off"></div>
  <div class="map-overlay-container">
    <div class="map-overlay top">
      <div class="map-overlay-inner">
        <h2>登記所備付地図データ<br />座標が不正確な筆を可視化</h2>
        <div>筆の件数: <span id="outside-area-count"></span></div>
        <label>市区町村外の面積の割合 <span id="outside-area"></span></label>
        <input id="slider" type="range" min="1" max="100" step="1" value="1">
        <div class="legend-container">
          <div id="legend-number">
            <div>1%</div>
            <div>50%</div>
            <div>100%</div>
          </div>
        </div>
        <a id="donwload"></a>
        <a class="attribution" href="https://front.geospatial.jp/houmu-chiseki/" target="_blank"
          rel="noopener noreferrer">
          <p>「登記所備付データ」（法務省）を加工して作成</p>
        </a>
      </div>
    </div>
  </div>
  <script src="https://cdn.geolonia.com/v1/embed?geolonia-api-key=YOUR-API-KEY"></script>
  <script>

    const fetchCSV = async (url) => {
      const response = await fetch(url);
      let text = await response.text();
      text = text.replace(/^.+\n/, '');

      const rows = text.split('\n').map((row) => {
        const columns = row.split(',');
        return columns;
      });
      return rows;
    }

    const convertArrayOfObjectsToCSV = (array) => {
      let result, columnDelimiter, lineDelimiter, data

      if (array == null || !array.length) {
        return null
      }

      columnDelimiter = ','
      lineDelimiter = '\n'

      data = typeof array !== 'object' ? JSON.parse(array) : array

      const keys = Object.keys(data[0])

      result = ''
      result += keys.join(columnDelimiter)
      result += lineDelimiter

      data.forEach(function (item) {
        let ctr = 0
        keys.forEach(function (key) {
          if (ctr > 0) result += columnDelimiter

          result += item[key]
          ctr++
        })
        result += lineDelimiter
      })

      return result
    }

    const downloadCSV = (csv, areaRate) => {
      const csvFile = new Blob([csv], { type: 'text/csv' })
      const filename = `outside_area_${areaRate}.csv`
      const label = areaRate === 0 ? '> 0' : '>= ' + areaRate

      const downloadLink = document.getElementById('donwload')
      downloadLink.textContent = `筆の一覧をダウンロード(${label}%)`
      downloadLink.download = filename
      downloadLink.href = window.URL.createObjectURL(csvFile)
    }

    const filterOutSideArea = (outsideAreaList, selectedOutSideRate) => {
      return outsideAreaList.filter((row) => {
        return Number(row[1]) >= selectedOutSideRate / 100;
      });
    }

    const setOutSideAreaCount = (outsideAreaList) => {
      document.getElementById("outside-area-count").textContent = `${outsideAreaList.length.toLocaleString()}件`;
    }

    const filterBy = (selectedOutSideRate) => {
      const filters = [">=", ["to-number", ["get", "outside_area_rate"]], selectedOutSideRate / 100];
      map.setFilter("outside-area/polygonFill", filters);
      map.setFilter("outside-area/polygonBorder", filters);
      map.setFilter("outside-area/polygonNameCity", filters);
      map.setFilter("outside-area/pointHeatmap", filters);

      let label;
      if (selectedOutSideRate === 0) {
        label = '> 0%';
      } else {
        label = `>= ${selectedOutSideRate}%`;
      }
      
      document.getElementById("outside-area").textContent = label;
    }

    const initial = 1

    const map = new geolonia.Map({
      container: "#map",
      style: "./style.json"
    });

    map.on('load', async () => {

      map.on('click', 'outside-area/polygonFill', (e) => {

        const properties = e.features[0].properties;

        let tableHTML = '';
        for (const key in properties) {
          let label = key;
          let value = properties[key];

          if (label === 'outside_area_rate') {
            label = '市区町村外の面積の割合'
            value = `${value * 100}%`
          }

          if (label === 'zip_file') {
            label = 'zipファイル名'
            value = `${value}.zip`
          }

          tableHTML += `<tr><th>${label}</th><td>${value}</td></tr>`;
        }

        const popup = new geolonia.Popup()
          .setLngLat(e.lngLat)
          .setHTML(`<table>${tableHTML}</table>`)
          .setMaxWidth("300px")
          .addTo(map);
      });

      const outsideAreaList = await fetchCSV('outside_area_files.csv');
      const outsideAreaListFiltered = filterOutSideArea(outsideAreaList, initial);
      setOutSideAreaCount(outsideAreaListFiltered);

      filterBy(initial);
      downloadCSV(convertArrayOfObjectsToCSV(outsideAreaList), initial)


      document.getElementById("slider").addEventListener("input", (e) => {
        const outSideRate = parseInt(e.target.value, 10);
        filterBy(outSideRate);

        const outsideAreaListFiltered = filterOutSideArea(outsideAreaList, outSideRate);

        setOutSideAreaCount(outsideAreaListFiltered);
        downloadCSV(convertArrayOfObjectsToCSV(outsideAreaListFiltered), outSideRate)
      });
    })
  </script>
</body>

</html>